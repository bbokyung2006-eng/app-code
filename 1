import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, updateDoc, increment, runTransaction, Timestamp } from 'firebase/firestore';
import {
  Home, BookOpen, ShoppingBag, Users, CheckCircle, Leaf, Sparkles, AlertTriangle, ArrowRight
} from 'lucide-react';

// --- ìƒìˆ˜ ë° ìœ í‹¸ë¦¬í‹° ---

// ì‚¬ìš©ìê°€ ì„¤ì •í•œ Firebase Global Variables ì‚¬ìš©
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ ìœ í‹¸ë¦¬í‹°
const getUserDocRef = (db, userId) => doc(db, `/artifacts/${appId}/users/${userId}/data/stats`);
const getLogCollectionRef = (db, userId) => collection(db, `/artifacts/${appId}/users/${userId}/daily_log`);

const TODAY = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

// ê¸°ë³¸ ë¯¸ì…˜ ë° í†µê³„ êµ¬ì¡°
const INITIAL_STATS = {
  points: 0,
  credits: 0,
  gardenLevel: 1, // ë²„ì¶”ì–¼ ê°€ë“  ë ˆë²¨ (ì„±ì¥ ë‹¨ê³„)
  lastLogin: TODAY,
  weeklyQuestProgress: 0,
};

const DAILY_MISSIONS = [
  { id: 'sunlight', name: 'ì°½ë¬¸ 5ë¶„ ì—´ê¸°', points: 10, difficulty: 1, required: false },
  { id: 'water', name: 'ë¬¼ í•œ ì” ë§ˆì‹œê¸°', points: 5, difficulty: 1, required: false },
  { id: 'clean', name: 'ì˜· 1ê°œ ê°œê¸°', points: 15, difficulty: 2, required: false },
  { id: 'micro_study', name: 'ë§ˆì´í¬ë¡œ í•™ìŠµ ì±Œë¦°ì§€ 1íšŒ', points: 20, difficulty: 2, required: true },
  { id: 'checkin', name: 'ìµëª… ì²´í¬ì¸ í¬ìŠ¤íŠ¸ ì‘ì„±', points: 10, difficulty: 1, required: false },
];

const WEEKLY_QUESTS = [
  { id: 'w_study', name: 'ë§ˆì´í¬ë¡œ í•™ìŠµ 5íšŒ ì„±ê³µ', progressKey: 'micro_study_count', target: 5 },
  { id: 'w_outing', name: 'ì™¸ì¶œ(ê±¸ìŒ ìˆ˜) 1íšŒ ê¸°ë¡', progressKey: 'outing_count', target: 1 },
  { id: 'w_contact', name: 'ì—°ë½ ì‹œë„(ê²©ë ¤ ì‚¬ì„œí•¨) 1íšŒ', progressKey: 'contact_count', target: 1 },
  { id: 'w_rhythm', name: 'ìƒí™œ ë¦¬ë“¬ ì²´í¬ 3ì¼ ì„±ê³µ', progressKey: 'rhythm_success_count', target: 3 },
];

const GARDEN_LEVELS = [
  { level: 1, name: 'ìƒˆì‹¹', growthThreshold: 0, color: 'text-green-500' },
  { level: 2, name: 'ì‘ì€ ì¤„ê¸°', growthThreshold: 100, color: 'text-green-600' },
  { level: 3, name: 'íŠ¼íŠ¼í•œ ë‚˜ë¬´', growthThreshold: 300, color: 'text-lime-700' },
  { level: 4, name: 'í’ì„±í•œ ì—´ë§¤', growthThreshold: 600, color: 'text-yellow-600' },
];

const COUPONS = [
  { id: 'coffee', name: 'í¸ì˜ì  ì»¤í”¼ êµí™˜ê¶Œ', cost: 1, description: 'ê°€ê¹Œìš´ í¸ì˜ì ì—ì„œ ë”°ëœ»í•œ ì»¤í”¼ í•œ ì”ê³¼ ì¬ë„ì•½ì˜ ìš©ê¸°ë¥¼ ì–»ìœ¼ì„¸ìš”.' },
  { id: 'book', name: 'ì„œì  ìƒí’ˆê¶Œ (5,000ì›)', cost: 3, description: 'ìƒˆë¡œìš´ ì§€ì‹ì´ë‚˜ í¥ë¯¸ë¥¼ ìœ„í•œ ì±…ì„ í•œ ê¶Œ êµ¬ë§¤í•´ ë³´ì„¸ìš”.' },
  { id: 'movie', name: 'ì˜í™” ê´€ëŒê¶Œ (1ì¸)', cost: 5, description: 'ì ì‹œ ì„¸ìƒ ë°–ìœ¼ë¡œ ë‚˜ì™€ ì˜í™” í•œ í¸ì„ ì¦ê²¨ë³´ì„¸ìš”.' },
];

// --- Firebase Custom Hook ---

const useFirebaseInit = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    try {
      if (Object.keys(firebaseConfig).length === 0) {
        console.error("Firebase config is missing.");
        setIsAuthReady(true);
        return;
      }

      const app = initializeApp(firebaseConfig);
      const firestoreDb = getFirestore(app);
      const firebaseAuth = getAuth(app);
      setDb(firestoreDb);
      setAuth(firebaseAuth);
      
      // Setting Firestore log level to Debug to assist in environment where it's needed
      // setLogLevel('Debug');

      const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          try {
            if (initialAuthToken) {
              await signInWithCustomToken(firebaseAuth, initialAuthToken);
            } else {
              await signInAnonymously(firebaseAuth);
            }
          } catch (error) {
            console.error("Sign-in failed. Using temporary ID:", error);
            setUserId(crypto.randomUUID());
          }
        }
        setIsAuthReady(true);
      });

      return () => unsubscribe();
    } catch (error) {
      console.error("Firebase initialization error:", error);
      setIsAuthReady(true);
    }
  }, []);

  return { db, userId, isAuthReady };
};

// --- App Component ---

const App = () => {
  const { db, userId, isAuthReady } = useFirebaseInit();
  const [currentPage, setCurrentPage] = useState('home');
  const [userStats, setUserStats] = useState(INITIAL_STATS);
  const [dailyLog, setDailyLog] = useState({});
  const [isLoading, setIsLoading] = useState(true);
  const [message, setMessage] = useState('');
  const [musicMessage, setMusicMessage] = useState('');

  // 1. ë°ì´í„° ë¡œë”© ë° ë™ê¸°í™” (onSnapshot)
  useEffect(() => {
    if (!isAuthReady || !db || !userId) return;

    // ì‚¬ìš©ì í†µê³„ (Points, Credits, Garden Level) ë™ê¸°í™”
    const statsRef = getUserDocRef(db, userId);
    
    // **FIX: 1. Ensure User Stats Document Exists**
    // setDoc with merge: true will create the document if it doesn't exist 
    // and initialize it with INITIAL_STATS, without overwriting existing data if it does.
    setDoc(statsRef, INITIAL_STATS, { merge: true })
        .catch(err => console.error("Failed to initialize user stats document:", err));

    const unsubscribeStats = onSnapshot(statsRef, (docSnap) => {
      const data = docSnap.exists() ? docSnap.data() : INITIAL_STATS;
      
      // ì¼ì¼ ì´ˆê¸°í™” í™•ì¸ ë¡œì§
      if (data.lastLogin !== TODAY) {
        // ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ ì¼ì¼ ë¯¸ì…˜ ë¡œê·¸ ì´ˆê¸°í™”
        setDailyLog({});
        // lastLogin ì—…ë°ì´íŠ¸ ë° ì£¼ê°„ í€˜ìŠ¤íŠ¸ ì¹´ìš´íŠ¸ ì´ˆê¸°í™” (í•„ìš”ì‹œ)
        updateDoc(statsRef, {
            lastLogin: TODAY
        }).catch(err => console.error("Failed to update last login:", err));
      }
      
      setUserStats(prev => ({ ...INITIAL_STATS, ...data }));
      setIsLoading(false);
    }, (error) => {
      console.error("Error fetching stats:", error);
      setIsLoading(false);
    });

    // ì˜¤ëŠ˜ ë‚ ì§œì˜ ì¼ì¼ ë¡œê·¸ ë™ê¸°í™”
    const logRef = doc(getLogCollectionRef(db, userId), TODAY);
    const unsubscribeLog = onSnapshot(logRef, (docSnap) => {
        setDailyLog(docSnap.exists() ? docSnap.data() : {});
    }, (error) => {
        console.error("Error fetching daily log:", error);
    });

    return () => {
      unsubscribeStats();
      unsubscribeLog();
    };
  }, [db, userId, isAuthReady]);

  // 2. ë¯¸ì…˜ ì™„ë£Œ ë° ë³´ìƒ ì²˜ë¦¬ ë¡œì§
  const handleMissionComplete = useCallback(async (missionId) => {
    if (!db || !userId) {
        setMessage('ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...');
        return;
    }

    const mission = DAILY_MISSIONS.find(m => m.id === missionId);
    if (!mission) return;

    const statsRef = getUserDocRef(db, userId);
    const logRef = doc(getLogCollectionRef(db, userId), TODAY);
    const logKey = `mission_${missionId}_completed`;

    try {
        await runTransaction(db, async (transaction) => {
            const logDoc = await transaction.get(logRef);
            if (logDoc.exists() && logDoc.data()[logKey]) {
                setMessage(`"${mission.name}" ë¯¸ì…˜ì€ ì´ë¯¸ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.`);
                return;
            }

            // 1. Daily Log ì—…ë°ì´íŠ¸ (ë¯¸ì…˜ ì™„ë£Œ í‘œì‹œ)
            transaction.set(logRef, { 
                [logKey]: true,
                completedAt: Timestamp.now(),
            }, { merge: true });

            // 2. User Stats ì—…ë°ì´íŠ¸ (í¬ì¸íŠ¸ ì¦ê°€)
            // statsRefëŠ” useEffectì—ì„œ setDocìœ¼ë¡œ ì¡´ì¬ê°€ ë³´ì¥ë˜ì—ˆìœ¼ë¯€ë¡œ updateë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            transaction.update(statsRef, {
                points: increment(mission.points),
                // ì£¼ê°„ í€˜ìŠ¤íŠ¸ ì§„í–‰ ì¹´ìš´íŠ¸ (ì˜ˆì‹œ: ë§ˆì´í¬ë¡œ í•™ìŠµì€ ì£¼ê°„ í€˜ìŠ¤íŠ¸ì— í¬í•¨)
                weeklyQuestProgress: increment(mission.required ? 1 : 0) // ì˜ˆì‹œë¡œ required ë¯¸ì…˜ë§Œ ì¹´ìš´íŠ¸
            });
            
            setMessage(`${mission.name} ì„±ê³µ! ì¬ë„ì•½ í¬ì¸íŠ¸ ${mission.points}ì  íšë“!`);
        });

        // 3. ì£¼ê°„ í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì—¬ë¶€ í™•ì¸ (íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ì²˜ë¦¬)
        // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì£¼ê°„ í€˜ìŠ¤íŠ¸ì˜ ë³µì¡í•œ ì¡°ê±´(ì™¸ì¶œ, ì—°ë½ ë“±)ì„ ë³„ë„ì˜ ì¹´ìš´í„°ë¡œ ê´€ë¦¬í•´ì•¼ í•¨.
        // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí™”í•˜ì—¬ weeklyQuestProgressê°€ ì¼ì • ì„ê³„ê°’ì„ ë„˜ìœ¼ë©´ í¬ë ˆë”§ì„ ì§€ê¸‰í•œë‹¤ê³  ê°€ì •.
        const weeklyTarget = WEEKLY_QUESTS.length * 5; // ì„ì˜ì˜ ì£¼ê°„ ëª©í‘œ ì„¤ì •
        if (userStats.weeklyQuestProgress + (mission.required ? 1 : 0) >= weeklyTarget) {
            await updateDoc(statsRef, {
                credits: increment(1),
                weeklyQuestProgress: 0, // ì´ˆê¸°í™”
            });
            setMessage(prev => prev + ' ì£¼ê°„ í€˜ìŠ¤íŠ¸ 4ê°œ ëª¨ë‘ ì„±ê³µ! ì¬ë„ì•½ í¬ë ˆë”§ 1ê°œ íšë“!');
        }

    } catch (error) {
        console.error("Mission completion failed:", error);
        setMessage('ë¯¸ì…˜ ì™„ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }, [db, userId, userStats.weeklyQuestProgress]);

  // 3. ìƒì  - ì¿ í° êµ¬ë§¤ ë¡œì§
  const handleCouponPurchase = useCallback(async (coupon) => {
    if (!db || !userId) return;
    if (userStats.credits < coupon.cost) {
      setMessage('í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
      return;
    }

    const statsRef = getUserDocRef(db, userId);

    try {
        await runTransaction(db, async (transaction) => {
            const docSnap = await transaction.get(statsRef);
            const currentCredits = docSnap.data().credits;
            
            if (currentCredits < coupon.cost) {
                // ì´ì¤‘ ì²´í¬
                throw new Error("Credit insufficient during transaction.");
            }
            
            // 1. í¬ë ˆë”§ ì°¨ê°
            // statsRefëŠ” useEffectì—ì„œ setDocìœ¼ë¡œ ì¡´ì¬ê°€ ë³´ì¥ë˜ì—ˆìœ¼ë¯€ë¡œ updateë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            transaction.update(statsRef, {
                credits: increment(-coupon.cost),
            });

            // 2. ì¿ í° ë°œê¸‰ ê¸°ë¡ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì¿ í° ì‚¬ìš© ì¶”ì ì„ ìœ„í•œ ë³„ë„ ì»¬ë ‰ì…˜ í•„ìš”)
            // ì—¬ê¸°ì„œëŠ” ì„ì‹œë¡œ ë©”ì‹œì§€ë¡œ ëŒ€ì²´
        });
        setMessage(`${coupon.name} êµ¬ë§¤ ì™„ë£Œ! ì‹¤ë¬¼ ì¿ í° ì‚¬ìš©ì„ ìœ„í•´ ì§‘ ë°–ìœ¼ë¡œ ë‚˜ê°ˆ ìš©ê¸°ë¥¼ ë‚´ë³´ì„¸ìš”!`);
    } catch (error) {
        console.error("Coupon purchase failed:", error);
        setMessage('ì¿ í° êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
  }, [db, userId, userStats.credits]);

  // 4. ì˜¤ëŠ˜ì˜ ê¸ì • ë©”ì‹œì§€ ë° ìŒì•… ì¶”ì²œ (LLM API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜)
  useEffect(() => {
    // ê¸ì • ë©”ì‹œì§€ ë° ìŒì•…ì€ ì•± ì ‘ì† ì‹œ í•œ ë²ˆë§Œ í˜¸ì¶œ
    const messages = [
        "ì˜¤ëŠ˜ì˜ ì‘ì€ ì›€ì§ì„ì´ ë‚´ì¼ì˜ í° ë³€í™”ë¥¼ ë§Œë“­ë‹ˆë‹¤.",
        "ë‹¹ì‹ ì´ ë©ˆì¶°ìˆë˜ ì‹œê°„ì€ ì¬ë„ì•½ì„ ìœ„í•œ ì¤€ë¹„ ê¸°ê°„ì´ì—ˆìŠµë‹ˆë‹¤.",
        "ê´œì°®ì•„ìš”. ì§€ê¸ˆ ì´ ìˆœê°„ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ë©´ ë©ë‹ˆë‹¤.",
        "ê°€ì¥ í˜ë“  ì¼ì€ ì‹œì‘í•˜ëŠ” ê²ƒì´ë‹¤. ë‹¹ì‹ ì€ ì´ë¯¸ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.",
        "ë‹¹ì‹ ì˜ ì†ë„ë¡œ ê°€ì„¸ìš”. ëŠ¦ì–´ë„ ê´œì°®ìŠµë‹ˆë‹¤."
    ];
    setMessage(messages[Math.floor(Math.random() * messages.length)]);
    setMusicMessage('ì˜¤ëŠ˜ì€ í¸ì•ˆí•˜ê³  ì°¨ë¶„í•œ Lo-Fi í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.');
    
    // ì‹¤ì œ LLM API í˜¸ì¶œ ì½”ë“œê°€ ë“¤ì–´ê°ˆ ìœ„ì¹˜:
    /*
    const fetchAIText = async (prompt, setStateFunc) => {
        // ... API í˜¸ì¶œ ë° ì‘ë‹µ ì²˜ë¦¬ ë¡œì§ (Google Search grounding X)
    }
    fetchAIText("ëœë¤ìœ¼ë¡œ ê¸ì •ì ì´ê³  í¬ë§ì ì¸ ë¬¸êµ¬ í•˜ë‚˜ë§Œ ì¶”ì²œí•´ì¤˜", setMessage);
    fetchAIText("ê¸°ë¶„ ì¢‹ì•„ì§€ê³  ì•ˆì •ê° ì£¼ëŠ” ë…¸ë˜ í•œ ê³¡ ì¶”ì²œí•˜ê³  ì œëª©ë§Œ ì•Œë ¤ì¤˜", setMusicMessage);
    */
  }, []);

  // 5. ë²„ì¶”ì–¼ ê°€ë“  ë ˆë²¨ ê³„ì‚°
  const gardenInfo = useMemo(() => {
    const totalPoints = userStats.points;
    let currentLevel = GARDEN_LEVELS[0];
    let nextLevel = null;

    for (let i = 0; i < GARDEN_LEVELS.length; i++) {
      if (totalPoints >= GARDEN_LEVELS[i].growthThreshold) {
        currentLevel = GARDEN_LEVELS[i];
      } else {
        nextLevel = GARDEN_LEVELS[i];
        break;
      }
    }

    const progress = nextLevel
      ? ((totalPoints - currentLevel.growthThreshold) / (nextLevel.growthThreshold - currentLevel.growthThreshold)) * 100
      : 100;

    return { currentLevel, nextLevel, progress: Math.min(progress, 100) };
  }, [userStats.points]);

  // --- UI Components ---

  const Header = () => (
    <div className="flex justify-between items-center p-4 border-b border-gray-100 bg-white">
      <h1 className="text-xl font-bold text-gray-800">Re:Start</h1>
      <div className="flex items-center space-x-3 text-sm font-medium">
        <Sparkles className="w-5 h-5 text-yellow-500" />
        <span className="text-gray-700">P: {userStats.points}</span>
        <ShoppingBag className="w-5 h-5 text-blue-500" />
        <span className="text-gray-700">C: {userStats.credits}</span>
      </div>
    </div>
  );

  const MessageBanner = ({ text, type = 'info' }) => {
    if (!text) return null;
    const color = type === 'info' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-green-50 border-green-200 text-green-700';
    return (
      <div className={`p-3 mx-4 mt-4 rounded-lg border text-sm font-medium ${color}`}>
        {text}
      </div>
    );
  };

  const Card = ({ children, title, icon: Icon }) => (
    <div className="bg-white p-5 rounded-xl shadow-lg border border-gray-100">
      <div className="flex items-center mb-3">
        {Icon && <Icon className="w-5 h-5 mr-2 text-indigo-500" />}
        <h2 className="text-lg font-semibold text-gray-800">{title}</h2>
      </div>
      {children}
    </div>
  );

  const HomeView = () => {
    const { currentLevel, nextLevel, progress } = gardenInfo;

    return (
      <div className="space-y-6 p-4">
        <MessageBanner text={`"${message}"`} type="info" />
        
        {/* ë©˜íƒˆ ì§€ì› ê¸°ëŠ¥ */}
        <Card title="ê¸°ë¶„ ì „í™˜í•˜ê¸°" icon={Sparkles}>
          <p className="text-sm text-gray-600 mb-2">
            **ì˜¤ëŠ˜ì˜ ê¸ì • ë©”ì‹œì§€:** <span className="font-semibold text-indigo-600">{message}</span>
          </p>
          <div className="flex items-center text-sm text-gray-600">
            <span className="mr-2">ğŸ¶ **ì¶”ì²œ ìŒì•…:**</span>
            <span className="font-medium">{musicMessage}</span>
          </div>
        </Card>

        {/* ë²„ì¶”ì–¼ ê°€ë“  */}
        <Card title="ë²„ì¶”ì–¼ ê°€ë“  (ë‚˜ì˜ íšŒë³µ ë‹¨ê³„)" icon={Leaf}>
          <div className="flex flex-col items-center py-4">
            <span className={`text-5xl mb-2 ${currentLevel.color}`}>
              {currentLevel.level === 1 ? 'ğŸŒ±' : currentLevel.level === 2 ? 'ğŸŒ¿' : currentLevel.level === 3 ? 'ğŸŒ³' : 'ğŸ'}
            </span>
            <p className="text-xl font-bold">{currentLevel.name}</p>
            <p className="text-sm text-gray-500 mt-1">
              {nextLevel ? `ë‹¤ìŒ ë ˆë²¨(${nextLevel.name})ê¹Œì§€ ${nextLevel.growthThreshold - userStats.points} P ë‚¨ìŒ` : 'ìµœê³  ë ˆë²¨ ë‹¬ì„±!'}
            </p>
            <div className="w-full bg-gray-200 rounded-full h-2.5 mt-3">
              <div className="bg-green-500 h-2.5 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
            </div>
          </div>
        </Card>

        {/* ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ */}
        <Card title="ë°ì¼ë¦¬ ë¯¸ì…˜: ìŠ¤ëª° ì•¡ì…˜" icon={CheckCircle}>
          <ul className="space-y-3">
            {DAILY_MISSIONS.map((m) => {
              const isCompleted = dailyLog[`mission_${m.id}_completed`];
              return (
                <li key={m.id} className={`flex justify-between items-center p-3 rounded-lg transition-colors ${isCompleted ? 'bg-green-50' : 'bg-gray-50 hover:bg-gray-100'}`}>
                  <span className={`flex-1 font-medium ${isCompleted ? 'line-through text-gray-500' : 'text-gray-800'}`}>
                    {m.name}
                  </span>
                  <div className="flex items-center space-x-2">
                    <span className="text-xs font-semibold text-indigo-600">+{m.points} P</span>
                    <button
                      onClick={() => handleMissionComplete(m.id)}
                      disabled={isCompleted}
                      className={`px-3 py-1 text-xs rounded-full transition-all ${isCompleted ? 'bg-green-500 text-white cursor-default' : 'bg-indigo-500 text-white hover:bg-indigo-600'}`}
                    >
                      {isCompleted ? 'ì™„ë£Œë¨' : 'ë„ì „!'}
                    </button>
                  </div>
                </li>
              );
            })}
          </ul>
        </Card>
      </div>
    );
  };

  const StudyView = () => (
    <div className="p-4 space-y-6">
      <h2 className="text-2xl font-bold text-gray-800">í•™ìŠµ ì§€ì›: ì¬ë„ì•½ì„ ìœ„í•œ ë„ì•½</h2>
      
      <Card title="ë§ˆì´í¬ë¡œ ìŠ¤í‚¬ ì±Œë¦°ì§€" icon={BookOpen}>
        <p className="text-sm text-gray-600 mb-4">5ë¶„~10ë¶„ ë¶„ëŸ‰ì˜ ì´ˆë‹¨ê¸° í•™ìŠµ ì±Œë¦°ì§€ì— ë„ì „í•´ë³´ì„¸ìš”. (ë¯¸ì…˜ ì™„ë£ŒëŠ” í™ˆ í™”ë©´ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤)</p>
        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
          <p className="font-medium text-yellow-800">ì˜¤ëŠ˜ì˜ ì±Œë¦°ì§€:</p>
          <p className="text-sm text-gray-700 mt-1">ê¸°ì´ˆ ì˜ì–´ ë‹¨ì–´ 3ê°œ (focus, effort, restart) í•™ìŠµí•˜ê³  ì¸ì¦í•˜ê¸°</p>
        </div>
      </Card>
      
      <Card title="ëœë¤ í•™ìŠµ ì§ê¶ (Silent Co-Study)" icon={Users}>
        <p className="text-sm text-gray-600 mb-4">ìµëª…ì˜ ë‹¤ë¥¸ ì‚¬ìš©ìì™€ í•¨ê»˜ ë°©í•´ ì—†ì´ íƒ€ì´ë¨¸ë§Œ ê³µìœ í•˜ë©° ê³µë¶€í•©ë‹ˆë‹¤. ì±„íŒ…/í™”ìƒ ì—°ê²°ì€ ì—†ìŠµë‹ˆë‹¤. ì™¸ë¡­ì§€ ì•Šì€ ì§‘ì¤‘ì„ ê²½í—˜í•˜ì„¸ìš”.</p>
        <button className="w-full py-2 bg-pink-500 text-white font-bold rounded-lg hover:bg-pink-600 transition-colors">
          ì§ê¶ ì°¾ê³  íƒ€ì´ë¨¸ ì‹œì‘
        </button>
      </Card>
    </div>
  );

  const ShopView = () => (
    <div className="p-4 space-y-6">
      <h2 className="text-2xl font-bold text-gray-800">ì˜¤í”„ë¼ì¸ ì¿ í° ìƒì  (C: {userStats.credits})</h2>
      <MessageBanner text="ì£¼ê°„ í€˜ìŠ¤íŠ¸ë¥¼ ì„±ê³µí•˜ì—¬ í¬ë ˆë”§ì„ ëª¨ìœ¼ê³ , ì¿ í°ìœ¼ë¡œ 'ë°”ê¹¥ í™œë™'ì— í•„ìš”í•œ ìš©ê¸°ë¥¼ ì–»ìœ¼ì„¸ìš”!" type="info" />

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {COUPONS.map(c => (
          <div key={c.id} className="bg-white p-5 rounded-xl shadow-lg border border-indigo-200">
            <h3 className="text-xl font-bold text-indigo-700">{c.name}</h3>
            <p className="text-sm text-gray-500 mt-1 mb-3">{c.description}</p>
            <div className="flex justify-between items-center pt-3 border-t border-dashed border-indigo-100">
              <span className="text-2xl font-extrabold text-blue-600">
                {c.cost} C
              </span>
              <button
                onClick={() => handleCouponPurchase(c)}
                disabled={userStats.credits < c.cost}
                className={`flex items-center px-4 py-2 text-sm font-bold rounded-lg transition-colors ${userStats.credits >= c.cost ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
              >
                <ShoppingBag className="w-4 h-4 mr-1" />
                êµ¬ë§¤í•˜ê¸°
              </button>
            </div>
          </div>
        ))}
      </div>
      <div className="p-4 bg-gray-100 rounded-lg text-sm text-gray-600">
        <p className="font-semibold mb-1">ğŸ’¡ ë‚˜ì˜ í˜„ì¬ í¬ë ˆë”§: {userStats.credits} C</p>
        <p>í¬ë ˆë”§ì€ **ì£¼ê°„ í€˜ìŠ¤íŠ¸** 4ê°œë¥¼ ëª¨ë‘ ë‹¬ì„±í•  ë•Œë§ˆë‹¤ 1ê°œì”© ì§€ê¸‰ë©ë‹ˆë‹¤.</p>
      </div>
    </div>
  );
  
  const NavigationView = ({ current }) => {
      const items = [
          { name: 'í™ˆ', icon: Home, page: 'home' },
          { name: 'í•™ìŠµ', icon: BookOpen, page: 'study' },
          { name: 'ìƒì ', icon: ShoppingBag, page: 'shop' },
          // { name: 'ì»¤ë®¤ë‹ˆí‹°', icon: Users, page: 'community' }, // ìµëª… ì²´í¬ì¸ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„
      ];

      return (
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 shadow-xl flex justify-around p-2">
              {items.map(item => (
                  <button
                      key={item.page}
                      onClick={() => setCurrentPage(item.page)}
                      className={`flex flex-col items-center p-2 rounded-lg transition-colors ${current === item.page ? 'text-indigo-600' : 'text-gray-500 hover:text-indigo-400'}`}
                  >
                      <item.icon className="w-6 h-6" />
                      <span className="text-xs mt-1">{item.name}</span>
                  </button>
              ))}
          </div>
      );
  };


  if (!isAuthReady) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-50">
        <p className="text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
      </div>
    );
  }

  // --- Main Render ---
  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      <Header />
      <div className="max-w-xl mx-auto">
        {currentPage === 'home' && <HomeView />}
        {currentPage === 'study' && <StudyView />}
        {currentPage === 'shop' && <ShopView />}
        {/* ì»¤ë®¤ë‹ˆí‹° í˜ì´ì§€ëŠ” HomeViewì˜ ë©”ì‹œì§€/ìŒì•… ì¶”ì²œìœ¼ë¡œ ì¼ë¶€ë¶„ ëŒ€ì²´ */}
      </div>
      <NavigationView current={currentPage} />
    </div>
  );
};

export default App;
